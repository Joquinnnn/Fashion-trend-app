# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jiUIhi6VmbY_6mYPjpGL7dzk5C5s63YX
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

# -----------------------------------------------------------------
# KONFIGURASI HALAMAN
# -----------------------------------------------------------------
st.set_page_config(
    page_title="FashionTrendChecker (Evaluasi)",
    page_icon="ðŸ‘•",
    layout="wide"
)

# -----------------------------------------------------------------
# FUNGSI BANTUAN
# -----------------------------------------------------------------
def format_bulan_indo(date_obj):
    """Mengubah datetime menjadi string bulan Indonesia"""
    if pd.isnull(date_obj): return "-"
    bulan_map = {
        1: 'Januari', 2: 'Februari', 3: 'Maret', 4: 'April', 5: 'Mei', 6: 'Juni',
        7: 'Juli', 8: 'Agustus', 9: 'September', 10: 'Oktober', 11: 'November', 12: 'Desember'
    }
    return f"{bulan_map[date_obj.month]} {date_obj.year}"

def get_production_recommendation(predicted_demand, safety_stock_pct):
    safety_stock_units = predicted_demand * (safety_stock_pct / 100)
    recommended_quantity = predicted_demand + safety_stock_units
    return int(recommended_quantity), int(safety_stock_units)


# -----------------------------------------------------------------
# --- LOAD DATA & LATIH MODEL ---
# -----------------------------------------------------------------
@st.cache_data
def load_and_train_model():
    try:
        # 1. BACA CSV
        df = pd.read_csv("data_sample.csv")

        # 2. BERSIHKAN DATA
        df['Month'] = pd.to_datetime(df['Month'])
        df['Sales'] = pd.to_numeric(df['Sales'], errors='coerce')
        df['TrendScore'] = pd.to_numeric(df['TrendScore'], errors='coerce')
        df['USD_IDR'] = pd.to_numeric(df['USD_IDR'], errors='coerce')
        df = df.dropna()

        # FILTER PENTING: Hapus data tahun 2020 (MonthIndex < 13) agar akurasi bagus
        df = df[df['MonthIndex'] >= 13]

        # 3. LATIH MODEL
        features = ['MonthIndex', 'TrendScore', 'USD_IDR']
        target = 'Sales'

        X_train = df[features]
        y_train = df[target]

        model = LinearRegression()
        model.fit(X_train, y_train)

        return model, df, features, target
    except Exception as e:
        st.error(f"Error: {e}")
        return None, None, None, None

model, df_history, features, target = load_and_train_model()

if model is None:
    st.stop()

# -----------------------------------------------------------------
# LOGIKA PREDIKSI BULAN DEPAN
# -----------------------------------------------------------------
last_row = df_history.iloc[-1]
next_month_index = int(last_row['MonthIndex']) + 1
next_date = last_row['Month'] + pd.DateOffset(months=1)
next_month_text = format_bulan_indo(next_date)
next_trend_score = float(last_row['TrendScore'])
next_usd_idr = float(last_row['USD_IDR'])

# -----------------------------------------------------------------
# UI - SIDEBAR
# -----------------------------------------------------------------
st.sidebar.header("Parameter Produksi")
safety_stock_percent = st.sidebar.slider(
    "Persentase Safety Stock (%)",
    min_value=0, max_value=50, value=20
)
st.sidebar.markdown("---")
st.sidebar.info(f"Data terakhir: **{format_bulan_indo(last_row['Month'])}**")
st.sidebar.text_input("Target Bulan (Index):", value=str(next_month_index), disabled=True)


# -----------------------------------------------------------------
# UI - HALAMAN UTAMA
# -----------------------------------------------------------------
st.title("ðŸ‘• FashionTrendChecker (Smart Forecast)")
st.subheader(f"Prediksi Permintaan: {next_month_text}")
st.markdown("---")

# Hitung Prediksi
input_features = pd.DataFrame({
    'MonthIndex': [next_month_index],
    'TrendScore': [next_trend_score],
    'USD_IDR': [next_usd_idr]
})
pred_demand = int(model.predict(input_features)[0])
reco_prod, safety_units = get_production_recommendation(pred_demand, safety_stock_percent)

# Tampilkan Metric Utama
col1, col2 = st.columns(2)
col1.metric("Prediksi Permintaan", f"{pred_demand} unit")
col2.metric("âœ… REKOMENDASI PRODUKSI", f"{reco_prod} unit", delta=f"+{safety_units} unit Safety Stock")

st.markdown("---")

# Visualisasi Gauge
avg_sales = df_history['Sales'].mean()
max_gauge = max(avg_sales * 2.0, reco_prod * 1.5)
fig_gauge = go.Figure(go.Indicator(
    mode = "gauge+number+delta",
    value = reco_prod,
    title = {'text': "Total Produksi (Unit)"},
    delta = {'reference': pred_demand},
    gauge = {
        'axis': {'range': [0, max_gauge]},
        'bar': {'color': "#2E8B57"},
        'steps' : [{'range': [0, pred_demand], 'color': "rgba(200, 200, 200, 0.3)"}],
        'threshold' : {'line': {'color': "red", 'width': 4}, 'thickness': 0.75, 'value': pred_demand}
    }
))
st.plotly_chart(fig_gauge, use_container_width=True)

# Grafik Tren
st.subheader("Tren Historis")
fig_history = go.Figure()
fig_history.add_trace(go.Scatter(x=df_history['Month'], y=df_history['Sales'], mode='lines+markers', name='Penjualan'))
fig_history.add_trace(go.Scatter(x=df_history['Month'], y=df_history['TrendScore'], mode='lines', name='Skor Tren', yaxis='y2', line=dict(dash='dot')))
fig_history.update_layout(yaxis2=dict(overlaying='y', side='right'))
st.plotly_chart(fig_history, use_container_width=True)


# =================================================================
# === BAGIAN EVALUASI (SESUAI GAMBAR PERMINTAAN) ===
# =================================================================
st.markdown("---")
st.header("Evaluasi Akurasi Model")

# Expander sesuai gambar
with st.expander("Klik untuk melihat detail evaluasi ðŸ”¬"):

    st.write("""
    Untuk menguji seberapa baik model ini, kita membagi data historis
    menjadi **80% data training** dan **20% data testing**.
    """)

    # 1. Split Data
    X = df_history[features]
    y = df_history[target]

    # Gunakan random_state=42 agar hasil konsisten
    X_train_eval, X_test_eval, y_train_eval, y_test_eval = train_test_split(
        X, y, test_size=0.2, random_state=42
    )

    # 2. Latih Model Evaluasi
    model_eval = LinearRegression()
    model_eval.fit(X_train_eval, y_train_eval)

    # 3. Prediksi Data Test
    y_pred_eval = model_eval.predict(X_test_eval)

    # 4. Hitung Metrik
    mae = mean_absolute_error(y_test_eval, y_pred_eval)
    rmse = np.sqrt(mean_squared_error(y_test_eval, y_pred_eval))
    r2 = r2_score(y_test_eval, y_pred_eval)

    # 5. TAMPILAN 3 KOLOM METRIK (Sesuai Gambar)
    mcol1, mcol2, mcol3 = st.columns(3)
    mcol1.metric("RÂ² Score", f"{r2:.2f}")
    mcol2.metric("MAE", f"{mae:.0f} unit")
    mcol3.metric("RMSE", f"{rmse:.0f} unit")

    st.markdown("---")

    # 6. TABEL PERBANDINGAN (Sesuai Gambar)
    st.write("Perbandingan Data Test (Aktual vs Prediksi):")

    # Buat DataFrame khusus tampilan
    results_df = pd.DataFrame({
        'Index': X_test_eval['MonthIndex'],
        'Aktual': y_test_eval,
        'Prediksi': y_pred_eval.round(0)
    }).sort_values(by='Index')

    # Reset index agar rapi (opsional, tapi bagus untuk tampilan)
    results_df = results_df.reset_index(drop=True)

    st.dataframe(results_df, use_container_width=True)

    # 7. GRAFIK SCATTER PLOT (Sesuai Gambar)
    st.subheader("Visualisasi: Aktual vs. Prediksi")

    fig_eval = go.Figure()

    # Titik Biru (Data Test)
    fig_eval.add_trace(go.Scatter(
        x=y_test_eval,
        y=y_pred_eval,
        mode='markers',
        name='Data Test',
        marker=dict(color='blue', size=10, opacity=0.7)
    ))

    # Garis Merah Putus-putus (Ideal)
    # Mencari titik min dan max untuk garis diagonal
    min_val = min(y_test_eval.min(), y_pred_eval.min())
    max_val = max(y_test_eval.max(), y_pred_eval.max())

    fig_eval.add_trace(go.Scatter(
        x=[min_val, max_val],
        y=[min_val, max_val],
        mode='lines',
        name='Prediksi Ideal (Aktual = Prediksi)',
        line=dict(color='red', dash='dash')
    ))

    fig_eval.update_layout(
        title='Perbandingan Penjualan Aktual vs. Prediksi Model',
        xaxis_title='Penjualan Aktual (Unit)',
        yaxis_title='Penjualan Prediksi (Unit)',
        showlegend=True
    )

    st.plotly_chart(fig_eval, use_container_width=True)