# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1jiUIhi6VmbY_6mYPjpGL7dzk5C5s63YX
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
from sklearn.linear_model import LinearRegression
from sklearn.model_selection import train_test_split
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

# -----------------------------------------------------------------
# KONFIGURASI HALAMAN
# -----------------------------------------------------------------
st.set_page_config(
    page_title="FashionTrendChecker (Auto Predict)",
    page_icon="ðŸ‘•",
    layout="wide"
)

# -----------------------------------------------------------------
# FUNGSI MODEL PREDIKSI
# -----------------------------------------------------------------
def get_production_recommendation(predicted_demand, safety_stock_pct):
    safety_stock_units = predicted_demand * (safety_stock_pct / 100)
    recommended_quantity = predicted_demand + safety_stock_units
    return int(recommended_quantity), int(safety_stock_units)


# -----------------------------------------------------------------
# --- 1. LOAD DATA TRAINING ---
# -----------------------------------------------------------------
@st.cache_data
def load_and_train_model():
    """
    Fungsi ini membaca data historis dan melatih model regresi.
    """
    try:
        # Membaca CSV (Pastikan delimiter sesuai, misal koma atau titik koma)
        # Kita asumsikan format standar CSV (koma)
        df = pd.read_csv("data_sample.csv")
    except FileNotFoundError:
        st.error("ERROR: File 'data_sample.csv' tidak ditemukan.")
        return None, None, None, None

    # Pastikan tipe data benar
    # MonthIndex dan USD_IDR harus angka
    # Sales dan TrendScore harus angka

    # Fitur yang digunakan untuk PREDIKSI (X)
    # Kita menggunakan MonthIndex (urutan waktu), TrendScore, dan USD_IDR
    features = ['MonthIndex', 'TrendScore', 'USD_IDR']
    target = 'Sales'

    X_train = df[features]
    y_train = df[target]

    # Latih model Linear Regression
    model = LinearRegression()
    model.fit(X_train, y_train)

    return model, df, features, target

# Load data dan latih model
model, df_history, features, target = load_and_train_model()

if model is None:
    st.stop()

# -----------------------------------------------------------------
# UI - SIDEBAR (Hanya Safety Stock)
# -----------------------------------------------------------------
st.sidebar.header("Parameter Produksi")
st.sidebar.info("Data Tren dan Ekonomi diambil otomatis dari data terakhir untuk prediksi bulan depan.")

# INPUT USER SATU-SATUNYA
safety_stock_percent = st.sidebar.slider(
    "Persentase Safety Stock (%)",
    min_value=0, max_value=50, value=20,
    help="Cadangan produksi untuk menghindari kehabisan stok."
)

# -----------------------------------------------------------------
# PROSES OTOMATISASI FITUR BULAN DEPAN
# -----------------------------------------------------------------
# Ambil baris data terakhir
last_row = df_history.iloc[-1]

# 1. Tentukan Bulan Depan (Next Month Index)
next_month_index = int(last_row['MonthIndex']) + 1

# 2. Prediksi/Asumsi Nilai Tren & Kurs untuk Bulan Depan
# Strategi: Menggunakan nilai terakhir yang diketahui (Naive Method)
# atau bisa menggunakan rata-rata 3 bulan terakhir.
# Di sini kita gunakan nilai terakhir agar konsisten.
next_trend_score = last_row['TrendScore']
next_usd_idr = last_row['USD_IDR']

# Tampilkan parameter otomatis di Sidebar agar user tahu
st.sidebar.markdown("---")
st.sidebar.subheader("Parameter Otomatis (Terdeteksi)")
st.sidebar.text(f"Bulan Index ke: {next_month_index}")
st.sidebar.text(f"Trend Score: {next_trend_score}")
st.sidebar.text(f"Kurs USD/IDR: {next_usd_idr}")


# -----------------------------------------------------------------
# UI - HALAMAN UTAMA (Dashboard)
# -----------------------------------------------------------------
st.title("ðŸ‘• FashionTrendChecker (Auto Predict)")
st.subheader(f"Prediksi Permintaan Bulan Berikutnya (Index {next_month_index})")
st.markdown("---")

# -----------------------------------------------------------------
# --- 3. BUAT PREDIKSI ---
# -----------------------------------------------------------------

# Siapkan data input untuk prediksi sesuai format features
input_features = pd.DataFrame({
    'MonthIndex': [next_month_index],
    'TrendScore': [next_trend_score],
    'USD_IDR': [next_usd_idr]
})

# Lakukan prediksi
pred_demand = model.predict(input_features)[0]
pred_demand = int(pred_demand) # Bulatkan

# Hitung rekomendasi
reco_prod, safety_units = get_production_recommendation(pred_demand, safety_stock_percent)

# -----------------------------------------------------------------
# --- 4. TAMPILKAN HASIL PREDIKSI ---
# -----------------------------------------------------------------
st.header("Hasil Analisis & Rekomendasi ðŸŽ¯")

# Tampilkan metrik utama
col1, col2 = st.columns(2)
with col1:
    st.metric(
        label="Prediksi Permintaan Pasar",
        value=f"{pred_demand} unit"
    )
    st.caption(f"""
    **Basis Prediksi:**
    Menggunakan Tren ({next_trend_score}) dan Kurs ({next_usd_idr})
    dari data bulan terakhir.
    """)

with col2:
    st.metric(
        label="âœ… REKOMENDASI PRODUKSI (Unit)",
        value=f"{reco_prod} unit",
        delta=f"+{safety_units} unit (Safety Stock {safety_stock_percent}%)"
    )
    st.caption(f"""
    **Target Produksi:**
    {pred_demand} (Prediksi) + {safety_units} (Buffer Stok).
    """)

st.markdown("---")

# -----------------------------------------------------------------
# --- 5. TAMPILKAN VISUALISASI ---
# -----------------------------------------------------------------

# Visualisasi Risiko Overproduction
st.subheader("Visualisasi Target Produksi")

avg_historical_sales = df_history['Sales'].mean()
max_gauge_value = max(avg_historical_sales * 2.0, reco_prod * 1.5)

fig_gauge = go.Figure(go.Indicator(
    mode = "gauge+number+delta",
    value = reco_prod,
    title = {'text': "Total Produksi (Unit)"},
    delta = {'reference': pred_demand},
    gauge = {
        'axis': {'range': [0, max_gauge_value]},
        'bar': {'color': "#2E8B57"}, # SeaGreen
        'steps' : [
            {'range': [0, pred_demand], 'color': "rgba(200, 200, 200, 0.3)"}, # Zona Demand
            {'range': [pred_demand, reco_prod], 'color': "rgba(255, 165, 0, 0.5)"}, # Zona Safety Stock
        ],
        'threshold' : {
            'line': {'color': "red", 'width': 4}, 'thickness': 0.75, 'value': pred_demand
        }
    }
))
fig_gauge.add_annotation(
    x=0.5, y=0.25,
    text=f"Batas Permintaan: {pred_demand}",
    showarrow=False,
    font=dict(size=12)
)
st.plotly_chart(fig_gauge, use_container_width=True)


# -----------------------------------------------------------------
# --- 6. TAMPILKAN DATA HISTORIS ---
# -----------------------------------------------------------------
st.subheader("Tren Penjualan Historis")

# Grafik Data Historis
fig_history = go.Figure()

# Trace Penjualan
fig_history.add_trace(go.Scatter(
    x=df_history['Month'], # Menggunakan format Tanggal String (YYYY-MM)
    y=df_history['Sales'],
    mode='lines+markers',
    name='Penjualan (Unit)',
    line=dict(color='#1f77b4', width=3)
))

# Trace Trend Score (Sumbu Y Kedua)
fig_history.add_trace(go.Scatter(
    x=df_history['Month'],
    y=df_history['TrendScore'],
    mode='lines',
    name='Skor Tren',
    yaxis='y2',
    line=dict(color='#ff7f0e', dash='dot')
))

# Layout Chart
fig_history.update_layout(
    title='Riwayat Penjualan & Skor Tren',
    xaxis_title='Bulan',
    yaxis=dict(title='Penjualan', titlefont=dict(color='#1f77b4')),
    yaxis2=dict(
        title='Skor Tren',
        titlefont=dict(color='#ff7f0e'),
        overlaying='y',
        side='right'
    ),
    legend=dict(x=0, y=1.1, orientation='h'),
    hovermode="x unified"
)

st.plotly_chart(fig_history, use_container_width=True)

# Tampilkan Tabel Data (Opsional, disembunyikan dalam expander)
with st.expander("Lihat Data Mentah"):
    st.dataframe(df_history, use_container_width=True)


# -----------------------------------------------------------------
# --- 7. EVALUASI MODEL ---
# -----------------------------------------------------------------
st.markdown("---")
st.header("Evaluasi Akurasi Model")

with st.expander("Klik untuk melihat detail performa model ðŸ”¬"):

    # 1. Split Data
    X = df_history[features]
    y = df_history[target]

    # Gunakan shuffle=False agar data test adalah data TERBARU (Time Series Split sederhana)
    # Atau random_state=42 seperti sebelumnya. Untuk time series, biasanya test data adalah data terakhir.
    # Namun untuk konsistensi dengan kode sebelumnya kita pakai random split.
    X_train_eval, X_test_eval, y_train_eval, y_test_eval = train_test_split(
        X, y, test_size=0.2, random_state=42
    )

    # 2. Latih Model Evaluasi
    model_eval = LinearRegression()
    model_eval.fit(X_train_eval, y_train_eval)

    # 3. Prediksi
    y_pred_eval = model_eval.predict(X_test_eval)

    # 4. Metrik
    mae = mean_absolute_error(y_test_eval, y_pred_eval)
    rmse = np.sqrt(mean_squared_error(y_test_eval, y_pred_eval))
    r2 = r2_score(y_test_eval, y_pred_eval)

    col_eval1, col_eval2, col_eval3 = st.columns(3)
    col_eval1.metric("RÂ² Score", f"{r2:.2f}")
    col_eval2.metric("MAE (Error Rata-rata)", f"{mae:.0f} unit")
    col_eval3.metric("RMSE", f"{rmse:.0f} unit")

    # 5. Tabel Perbandingan
    results_df = pd.DataFrame({
        'Index': X_test_eval['MonthIndex'],
        'Aktual': y_test_eval,
        'Prediksi': y_pred_eval.round(0)
    }).sort_values(by='Index')

    st.write("Perbandingan Data Test (Aktual vs Prediksi):")
    st.dataframe(results_df, use_container_width=True)